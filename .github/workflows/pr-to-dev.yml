name: PR to Dev - Unit Tests

on:
  pull_request:
    branches: [dev]
    types: [opened, synchronize, reopened]

env:
  GO_VERSION: "1.25"
  COVERAGE_THRESHOLD: 33

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Configure private repos
        run: |
          git config --global url."https://${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
        env:
          GOPRIVATE: github.com/EduGoGroup/*

      - name: Download dependencies
        run: go mod download

      - name: Run unit tests
        run: make test-unit
        timeout-minutes: 5

      - name: Coverage report
        run: make coverage-report
        timeout-minutes: 5

      - name: Upload coverage
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: coverage-report-unit
          path: coverage/
          retention-days: 7

  lint:
    name: Lint & Format Check
    uses: EduGoGroup/edugo-infrastructure/.github/workflows/reusable-go-lint.yml@main
    with:
      go-version: "1.25"
      args: "--timeout=5m"

  summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, lint]
    if: always()

    steps:
      - name: Generate summary
        uses: actions/github-script@v7
        with:
          script: |
            const unitTests = '${{ needs.unit-tests.result }}';
            const lint = '${{ needs.lint.result }}';

            const summary = `## PR to Dev - Check Summary

            | Check | Status |
            |-------|--------|
            | Unit Tests | ${unitTests} |
            | Lint & Format | ${lint} |

            ${unitTests === 'success' && lint === 'success' ? 'All checks passed' : 'Some checks failed'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
